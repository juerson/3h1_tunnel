import{connect as z}from"cloudflare:sockets";function F(e){if("string"!=typeof e)throw new TypeError("sha224Encrypt: input must be a string");let t=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function r(e,t){return e>>>t|e<<32-t}let n=(new TextEncoder).encode(e),i=8*n.length,o=n.length+9+63>>6<<6,a=new Uint8Array(o);a.set(n),a[n.length]=128,new DataView(a.buffer).setUint32(a.length-4,i,!1);let I=new Uint32Array(64),s=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428].slice();for(let e=0;e<a.length;e+=64){let n=new DataView(a.buffer,e,64);for(let e=0;e<16;e++)I[e]=n.getUint32(4*e);for(let e=16;e<64;e++){let t=r(I[e-15],7)^r(I[e-15],18)^I[e-15]>>>3,n=r(I[e-2],17)^r(I[e-2],19)^I[e-2]>>>10;I[e]=I[e-16]+t+I[e-7]+n>>>0}let[i,o,l,c,g,C,d,u]=s;for(let e=0;e<64;e++){let n=u+(r(g,6)^r(g,11)^r(g,25))+(g&C^~g&d)+t[e]+I[e]>>>0,a=(r(i,2)^r(i,13)^r(i,22))+(i&o^i&l^o&l)>>>0;[u,d,C,g,c,l,o,i]=[d,C,g,c+n>>>0,l,o,i,n+a>>>0]}s[0]=s[0]+i>>>0,s[1]=s[1]+o>>>0,s[2]=s[2]+l>>>0,s[3]=s[3]+c>>>0,s[4]=s[4]+g>>>0,s[5]=s[5]+C>>>0,s[6]=s[6]+d>>>0,s[7]=s[7]+u>>>0}return s.slice(0,7).map(e=>e.toString(16).padStart(8,"0")).join("")}function R(e){let t=(new TextEncoder).encode(e),r=Array.from(t,e=>String.fromCharCode(e)).join("");return btoa(r)}function y(e){let t=atob(e),r=new Uint8Array([...t].map(e=>e.charCodeAt(0)));return(new TextDecoder).decode(r)}async function Y(e,t,r,n,i="main"){let o=`https://api.github.com/repos/${t}/${r}/contents/${n}?ref=${i}`;try{let t=await fetch(o,{headers:{Authorization:`token ${e}`,Accept:"application/vnd.github.v3.raw","User-Agent":"Mozilla/5.0"}});if(!t.ok)return console.error(`GitHub API Error: ${t.status} ${t.statusText}`),a();let r=t.headers.get("Content-Type")||"application/octet-stream";return{body:await t.arrayBuffer(),contentType:r}}catch(e){return console.error(`Network or parsing error: ${e.message}`),a()}function a(){return{body:new ArrayBuffer(0),contentType:"text/plain; charset=utf-8"}}}async function L(e){try{let t=await fetch(e);if(t.ok)return await t.text();console.error(`Failed to get: ${t.status}`)}catch(t){console.error(`Failed to fetch ${e} web content: ${t.message}`)}return""}function de(e,t){let r=[];for(let n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r}function E(e,t,r,n=500,i=300){if(!Array.isArray(e))return{hasError:!0,message:"输入数据不是有效的数组"};let o=t>0&&t<=n?t:i,a=de(e,o),I=a.length;if(r>I||r<1)return{hasError:!0,message:"数据为空，或者没有该页数，数据过少远达不到这个页码！"};let s=a[r-1];return console.log(`当前页码：${r}，总页数：${I}，每页最大节点数：${o}`),{chunkedIPs:s,totalPage:I}}function X(e){let t,r,n=e=>(e=+e)>=1&&e<=65535?e:443,i=443;if("["===e[0]){if(-1===(r=e.indexOf("]")))return{hostname:null,port:null};t=e.slice(0,r+1),":"===e[r+1]&&(i=n(e.slice(r+2)))}else-1!==(r=e.lastIndexOf(":"))&&e.indexOf(":")===r?(t=e.slice(0,r),i=n(e.slice(r+1))):t=e;return{hostname:t,port:i}}function S(e){let t,r,n,i,[o,a]=e.split("@").reverse();if(a){let e=a.split(":");if(2!==e.length)throw new Error("Invalid SOCKS address format");[t,r]=e}let I=o.split(":");if(i=Number(I.pop()),isNaN(i))throw new Error("Invalid SOCKS address format");n=I.join(":");if(n.includes(":")&&!/^\[.*\]$/.test(n))throw new Error("Invalid SOCKS address format");return{username:t,password:r,hostname:n,port:i}}function ge(e){if("string"!=typeof e)return!1;let t=e.match(/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\/(\d{1,2})$/);if(!t)return!1;let r=t[1].split(".").map(Number),n=Number(t[2]);return!(r.some(e=>e<0||e>255||!Number.isInteger(e))||n<0||n>32||!Number.isInteger(n))}function Ce(e){let[t,r]=e.split("/"),n=t.split(".").map(Number),i=n[0]<<24|n[1]<<16|n[2]<<8|n[3],o=32-parseInt(r,10);return{base:i>>>0,count:0===o?2**32:2**o}}function V(e){return[e>>>24&255,e>>>16&255,e>>>8&255,255&e].join(".")}function ue(e,t){t>e&&(t=e);let r=Array.from({length:e},(e,t)=>t);for(let n=0;n<t;n++){let t=n+Math.floor(Math.random()*(e-n));[r[n],r[t]]=[r[t],r[n]]}return r.slice(0,t)}function M(e,t=1e3,r=4){try{if(!ge(e))return[];if(!Number.isInteger(t)||t<=0)return[];let{base:n,count:i}=Ce(e);if(!Number.isFinite(i)||i<=0)return[];if(i<=2048||i<=t*r)return i<=t?Array.from({length:i},(e,t)=>V(n+t)):ue(i,t).map(e=>V(n+e));let o=new Set,a=10*t,I=0;for(;o.size<t&&I<a;){let e=Math.floor(Math.random()*i);o.add(V(n+e)),I++}return o.size<t?[]:Array.from(o)}catch(e){return console.log("function generateIPsFromCIDR error:",e),[]}}var T=["Y2hyb21l","ZmlyZWZveA==","ZWRnZQ==","c2FmYXJp","aW9z","YW5kcm9pZA==","cmFuZG9t","cmFuZG9taXplZA=="],x=[80,8080,8880,2052,2082,2086,2095],H=[443,2053,2083,2087,2096,8443];function J(e){return e[Math.floor(Math.random()*e.length)]}function Ae(e){return e.replace(/^# (.*$)/gim,"<h1>$1</h1>").replace(/^## (.*$)/gim,"<h2>$1</h2>").replace(/^### (.*$)/gim,"<h3>$1</h3>").replace(/`{3}([\s\S]*?)`{3}/gim,"<pre><code>$1</code></pre>").replace(/`([^`]+)`/gim,"<code>$1</code>").replace(/\*\*(.*?)\*\*/gim,"<strong>$1</strong>").replace(/\*(.*?)\*/gim,"<em>$1</em>").replace(/\n$/gim,"<br />")}function K(e,t,r="/"){let{uuid:n,password:i,onSs:o}=e,a="www.visa.com",I=r,s=e=>encodeURIComponent([`${atob("djJyYXktcGx1Z2lu")}`,...e?[]:["tls"],"mux=0","mode=websocket",`path=${I}`,`host=${t}`].join(";")),l=[{tls:"none",port:J(x),plugin:s(!0),randomfp:atob(J(T))},{tls:"tls",port:J(H),plugin:s(!1),randomfp:atob(J(T))}],c=[];for(let e of l){let r=e.tls,s=e.plugin,l=e.randomfp,g=`${a}:${e.port}`,C=encodeURIComponent(`cfwks-${g}`),d=[`${atob("dmxlc3M6Ly8=")}${n}@${g}?${atob("ZW5jcnlwdGlvbj1ub25l")}&security=${r}&fp=${l}&${atob("YWxsb3dJbnNlY3VyZT0xJnR5cGU9d3M=")}&host=${t}&path=${encodeURIComponent(I)}#${C}`,`${atob("dHJvamFuOi8v")}${i}@${g}?security=${r}&fp=${l}&${atob("YWxsb3dJbnNlY3VyZT0xJnR5cGU9d3M=")}&host=${t}&path=${encodeURIComponent(I)}#${C}`,...o?[`${atob("c3M6Ly8=")}bm9uZTpub25l@${g}?plugin=${s}#${C}`]:[]];c.push(d)}let g=["ICAgIHsgDQogICAgICAidHlwZSI6ICJ2bGVzcyIsDQogICAgICAidGFnIjogIiNyZW1hcmtzIyIsDQogICAgICAic2VydmVyIjogIiNzZXJ2ZXIjIiwNCiAgICAgICJzZXJ2ZXJfcG9ydCI6ICNwb3J0IywNCiAgICAgICJ1dWlkIjogIiN1dWlkNCMiLA0KICAgICAgIm5ldHdvcmsiOiAidGNwIiwNCiAgICAgICJ0bHMiOiB7DQogICAgICAgICJlbmFibGVkIjogI3RscyMsDQogICAgICAgICJpbnNlY3VyZSI6IHRydWUsDQogICAgICAgICJzZXJ2ZXJfbmFtZSI6ICIjaG9zdE5hbWUjIiwNCiAgICAgICAgInV0bHMiOiB7DQogICAgICAgICAgImVuYWJsZWQiOiB0cnVlLA0KICAgICAgICAgICJmaW5nZXJwcmludCI6ICIjZnAjIg0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgInRyYW5zcG9ydCI6IHsNCiAgICAgICAgInR5cGUiOiAid3MiLA0KICAgICAgICAicGF0aCI6ICIjcGF0aCMiLA0KICAgICAgICAiaGVhZGVycyI6IHsNCiAgICAgICAgICAiSG9zdCI6ICIjaG9zdE5hbWUjIg0KICAgICAgICB9DQogICAgICB9DQogICAgfQ","ICAgIHsNCiAgICAgICJ0eXBlIjogInRyb2phbiIsDQogICAgICAidGFnIjogIiNyZW1hcmtzIyIsDQogICAgICAic2VydmVyIjogIiNzZXJ2ZXIjIiwNCiAgICAgICJzZXJ2ZXJfcG9ydCI6ICNwb3J0IywNCiAgICAgICJwYXNzd29yZCI6ICIjcGFzc3dvcmQjIiwNCiAgICAgICJuZXR3b3JrIjogInRjcCIsDQogICAgICAidGxzIjogew0KICAgICAgICAiZW5hYmxlZCI6ICN0bHMjLA0KICAgICAgICAiaW5zZWN1cmUiOiB0cnVlLA0KICAgICAgICAic2VydmVyX25hbWUiOiAiI2hvc3ROYW1lIyIsDQogICAgICAgICJ1dGxzIjogew0KICAgICAgICAgICJlbmFibGVkIjogdHJ1ZSwNCiAgICAgICAgICAiZmluZ2VycHJpbnQiOiAiI2ZwIyINCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgICJ0cmFuc3BvcnQiOiB7DQogICAgICAgICJ0eXBlIjogIndzIiwNCiAgICAgICAgInBhdGgiOiAiI3BhdGgjIiwNCiAgICAgICAgImhlYWRlcnMiOiB7DQogICAgICAgICAgIkhvc3QiOiAiI2hvc3ROYW1lIyINCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0",...o?["ICAgIHsNCiAgICAgICJ0eXBlIjogInNoYWRvd3NvY2tzIiwNCiAgICAgICJ0YWciOiAiI3JlbWFya3MjIiwNCiAgICAgICJzZXJ2ZXIiOiAiI3NlcnZlciMiLA0KICAgICAgInNlcnZlcl9wb3J0IjogI3BvcnQjLA0KICAgICAgIm1ldGhvZCI6ICJub25lIiwNCiAgICAgICJwYXNzd29yZCI6ICJub25lIiwNCiAgICAgICJwbHVnaW4iOiAidjJyYXktcGx1Z2luIiwNCiAgICAgICJwbHVnaW5fb3B0cyI6ICIjdGxzdHIjbXV4PTA7bW9kZT13ZWJzb2NrZXQ7cGF0aD0jcGF0aCM7aG9zdD0jaG9zdE5hbWUjIg0KICAgIH0"]:[]],C=["cHJveGllczoKICAtIHR5cGU6IHZsZXNzCiAgICBuYW1lOiAnI3JlbWFya3MjJwogICAgc2VydmVyOiAnI3NlcnZlciMnCiAgICBwb3J0OiAjcG9ydCMKICAgIHV1aWQ6ICcjdXVpZDQjJwogICAgbmV0d29yazogd3MKICAgIHRsczogI3RscyMKICAgIHVkcDogZmFsc2UKICAgIHNlcnZlcm5hbWU6ICcjaG9zdE5hbWUjJwogICAgY2xpZW50LWZpbmdlcnByaW50OiAnI2ZwIycKICAgIHNraXAtY2VydC12ZXJpZnk6IHRydWUKICAgIHdzLW9wdHM6CiAgICAgIHBhdGg6ICcjcGF0aCMnCiAgICAgIGhlYWRlcnM6CiAgICAgICAgSG9zdDogJyNob3N0TmFtZSMnCiAgLSB0eXBlOiB0cm9qYW4KICAgIG5hbWU6ICcjcmVtYXJrcyMnCiAgICBzZXJ2ZXI6ICcjc2VydmVyIycKICAgIHBvcnQ6ICNwb3J0IwogICAgcGFzc3dvcmQ6ICcjcGFzc3dvcmQjJwogICAgbmV0d29yazogd3MKICAgIHVkcDogZmFsc2UKICAgIHNuaTogJyNob3N0TmFtZSMnCiAgICBjbGllbnQtZmluZ2VycHJpbnQ6ICcjZnAjJwogICAgc2tpcC1jZXJ0LXZlcmlmeTogdHJ1ZQogICAgd3Mtb3B0czoKICAgICAgcGF0aDogJyNwYXRoIycKICAgICAgaGVhZGVyczoKICAgICAgICBIb3N0OiAnI2hvc3ROYW1lIyc",...o?["ICAtIHR5cGU6IHNzCiAgICBuYW1lOiAnI3JlbWFya3MjJwogICAgc2VydmVyOiAnI3NlcnZlciMnCiAgICBwb3J0OiAjcG9ydCMKICAgIGNpcGhlcjogbm9uZQogICAgcGFzc3dvcmQ6IG5vbmUKICAgIHVkcDogZmFsc2UKICAgIHBsdWdpbjogdjJyYXktcGx1Z2luCiAgICBwbHVnaW4tb3B0czoKICAgICAgbW9kZTogd2Vic29ja2V0CiAgICAgIHRsczogI3RscyMKICAgICAgaG9zdDogJyNob3N0TmFtZSMnCiAgICAgIHBhdGg6ICcjcGF0aCMnCiAgICAgIG11eDogZmFsc2U"]:[]],d={"#remarks#":"cfwks-ws-tls","#server#":a,"#port#":J(H),"#uuid4#":n,"#password#":i,"#tls#":!0,"#hostName#":t,"#path#":I,"#fp#":atob(J(T)),"#tlstr#":"tls;"},u=new RegExp(Object.keys(d).join("|"),"g"),A=[];g.forEach(e=>{let t=y(e).replace(u,e=>d[e]),r=JSON.parse(t);A.push(r)});let m=[];C.forEach(e=>{let t=y(e).replace(u,e=>d[e]);m.push(t)});let p=o?`\n### 3、${y("c3PljY/orq7lnKh2MnJheU4vdjJyYXlOR+S4reS9v+eUqA==")}\n\`\`\`${y("5Yir5ZCNKHJlbWFyayk6")}            cfwks-ss\n${y("5Zyw5Z2AKGFkZHJlc3MpOg==")}           ${a}\n${y("56uv5Y+jKHBvcnQpOg==")}              ${l[1].port}\n${y("5a+G56CBKHBhc3N3b3JkKTo=")}          0\n${y("5Yqg5a+G5pa55byPKGVuY3J5cHRpb24pOg==")}    none\n\n${y("5bqV5bGC5Lyg6L6T5pa55byPKHRyYW5zcG9ydCk=")}\n${y("5Lyg6L6T5Y2P6K6uKG5ldHdvcmspOg==")}        ws\n${y("5Lyq6KOF5Z+f5ZCNKGhvc3QpOg==")}           ${t}\n${y("6Lev5b6EKHBhdGgpOg==")}               ${I}\n\n${y("5Lyg6L6T5bGC5a6J5YWoKFRMUyk6")}          tls\n\`\`\``:"",h=Ae(`## 一、${y("5YiG5Lqr6ZO+5o6l")}\n### 1、${y("V2Vic29ja2V0ICsgTlRMUw==")}\n\`\`\`${c[0].join("\n")}\`\`\`\n### 2、${y("V2Vic29ja2V0ICsgVExT")}\n\`\`\`${c[1].join("\n")}\`\`\`${p}\n## 二、${y("566A5piTIHNpbmctYm94IOmFjee9rg==")}\n\`\`\`${JSON.stringify({outbounds:A},null,2)}\`\`\`\n## 三、${y("566A5piTIGNsYXNoL21paG9tbyDphY3nva4=")}\n\`\`\`${m.join("\n")}\`\`\``);return y("PCFET0NUWVBFIGh0bWw+DQo8aHRtbD4NCg0KPGhlYWQ+DQoJPG1ldGEgY2hhcnNldD0idXRmLTgiPg0KCTxzdHlsZT4NCgkJaHRtbCwNCgkJYm9keSB7DQoJCQltYXJnaW46IDA7DQoJCQlwYWRkaW5nOiAwOw0KCQkJZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgc2Fucy1zZXJpZjsNCgkJCWJhY2tncm91bmQ6ICNmMGYyZjU7DQoJCQlkaXNwbGF5OiBmbGV4Ow0KCQkJanVzdGlmeS1jb250ZW50OiBjZW50ZXI7DQoJCQlhbGlnbi1pdGVtczogY2VudGVyOw0KCQl9DQoNCgkJLmJveCB7DQoJCQliYWNrZ3JvdW5kOiB3aGl0ZTsNCgkJCW1heC13aWR0aDogMTIwMHB4Ow0KCQkJd2lkdGg6IDkwJTsNCgkJCXBhZGRpbmc6IDJyZW07DQoJCQlib3JkZXItcmFkaXVzOiAxMnB4Ow0KCQkJYm94LXNoYWRvdzogMCA0cHggMjBweCByZ2JhKDAsIDAsIDAsIDAuMSk7DQoJCX0NCg0KCQloMSwNCgkJaDIsDQoJCWgzIHsNCgkJCW1hcmdpbi10b3A6IDA7DQoJCX0NCg0KCQlwcmUgew0KCQkJYmFja2dyb3VuZDogI2VlZTsNCgkJCXBhZGRpbmc6IDFlbTsNCgkJCW92ZXJmbG93LXg6IGF1dG87DQoJCQlib3JkZXItcmFkaXVzOiA2cHg7DQoJCX0NCg0KCQljb2RlIHsNCgkJCWZvbnQtZmFtaWx5OiB1aS1tb25vc3BhY2UsIG1vbm9zcGFjZTsNCgkJfQ0KCTwvc3R5bGU+DQo8L2hlYWQ+DQoNCjxib2R5Pg0KCTxkaXYgY2xhc3M9ImJveCI+DQoJCSR7aHRtbH0NCgk8L2Rpdj4NCjwvYm9keT4NCg0KPC9odG1sPg0K").replace("${html}",h)}function _(e,t,r,n="/",i=0){let o=n,a=r.endsWith(atob("LndvcmtlcnMuZGV2")),I=a?"none":"tls",s=a?x:H,l=encodeURIComponent([`${atob("djJyYXktcGx1Z2lu")}`,...a?[]:["tls"],"mux=0","mode=websocket",`path=${o}`,`host=${r}`].join(";")),{uuid:c,password:g,onSs:C}=t,d=[];for(let t of e){if(!t)continue;let e=`${t}:${0!==i?i:J(s)}`,n=encodeURIComponent(`cfwks-${e}`),a=atob(J(T)),u=[`${atob("dmxlc3M6Ly8=")}${c}@${e}?${atob("ZW5jcnlwdGlvbj1ub25l")}&security=${I}&fp=${a}&${atob("YWxsb3dJbnNlY3VyZT0xJnR5cGU9d3M=")}&host=${r}&path=${encodeURIComponent(o)}#${n}`,`${atob("dHJvamFuOi8v")}${g}@${e}?security=${I}&fp=${a}&${atob("YWxsb3dJbnNlY3VyZT0xJnR5cGU9d3M=")}&host=${r}&path=${encodeURIComponent(o)}#${n}`,...C?[`${atob("c3M6Ly8=")}bm9uZTpub25l@${e}?plugin=${l}#${n}`]:[]];d.push(J(u))}return R(d.join("\n"))}function q(e,t,r,n="/",i=0){let o=r.endsWith(atob("LndvcmtlcnMuZGV2")),a=o?x:H,{uuid:I,password:s,onSs:l}=t,c=n,g=["ICAgIHsgDQogICAgICAidHlwZSI6ICJ2bGVzcyIsDQogICAgICAidGFnIjogIiNyZW1hcmtzIyIsDQogICAgICAic2VydmVyIjogIiNzZXJ2ZXIjIiwNCiAgICAgICJzZXJ2ZXJfcG9ydCI6ICNwb3J0IywNCiAgICAgICJ1dWlkIjogIiN1dWlkNCMiLA0KICAgICAgIm5ldHdvcmsiOiAidGNwIiwNCiAgICAgICJ0bHMiOiB7DQogICAgICAgICJlbmFibGVkIjogI3RscyMsDQogICAgICAgICJpbnNlY3VyZSI6IHRydWUsDQogICAgICAgICJzZXJ2ZXJfbmFtZSI6ICIjaG9zdE5hbWUjIiwNCiAgICAgICAgInV0bHMiOiB7DQogICAgICAgICAgImVuYWJsZWQiOiB0cnVlLA0KICAgICAgICAgICJmaW5nZXJwcmludCI6ICIjZnAjIg0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgInRyYW5zcG9ydCI6IHsNCiAgICAgICAgInR5cGUiOiAid3MiLA0KICAgICAgICAicGF0aCI6ICIjcGF0aCMiLA0KICAgICAgICAiaGVhZGVycyI6IHsNCiAgICAgICAgICAiSG9zdCI6ICIjaG9zdE5hbWUjIg0KICAgICAgICB9DQogICAgICB9DQogICAgfQ","ICAgIHsNCiAgICAgICJ0eXBlIjogInRyb2phbiIsDQogICAgICAidGFnIjogIiNyZW1hcmtzIyIsDQogICAgICAic2VydmVyIjogIiNzZXJ2ZXIjIiwNCiAgICAgICJzZXJ2ZXJfcG9ydCI6ICNwb3J0IywNCiAgICAgICJwYXNzd29yZCI6ICIjcGFzc3dvcmQjIiwNCiAgICAgICJuZXR3b3JrIjogInRjcCIsDQogICAgICAidGxzIjogew0KICAgICAgICAiZW5hYmxlZCI6ICN0bHMjLA0KICAgICAgICAiaW5zZWN1cmUiOiB0cnVlLA0KICAgICAgICAic2VydmVyX25hbWUiOiAiI2hvc3ROYW1lIyIsDQogICAgICAgICJ1dGxzIjogew0KICAgICAgICAgICJlbmFibGVkIjogdHJ1ZSwNCiAgICAgICAgICAiZmluZ2VycHJpbnQiOiAiI2ZwIyINCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgICJ0cmFuc3BvcnQiOiB7DQogICAgICAgICJ0eXBlIjogIndzIiwNCiAgICAgICAgInBhdGgiOiAiI3BhdGgjIiwNCiAgICAgICAgImhlYWRlcnMiOiB7DQogICAgICAgICAgIkhvc3QiOiAiI2hvc3ROYW1lIyINCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0",...l?["ICAgIHsNCiAgICAgICJ0eXBlIjogInNoYWRvd3NvY2tzIiwNCiAgICAgICJ0YWciOiAiI3JlbWFya3MjIiwNCiAgICAgICJzZXJ2ZXIiOiAiI3NlcnZlciMiLA0KICAgICAgInNlcnZlcl9wb3J0IjogI3BvcnQjLA0KICAgICAgIm1ldGhvZCI6ICJub25lIiwNCiAgICAgICJwYXNzd29yZCI6ICJub25lIiwNCiAgICAgICJwbHVnaW4iOiAidjJyYXktcGx1Z2luIiwNCiAgICAgICJwbHVnaW5fb3B0cyI6ICIjdGxzdHIjbXV4PTA7bW9kZT13ZWJzb2NrZXQ7cGF0aD0jcGF0aCM7aG9zdD0jaG9zdE5hbWUjIg0KICAgIH0"]:[]],C=[],d=[];for(let t of e){if(!t)continue;let e=0!==i?i:J(a),n=`cfwks-${t}:${e}`,l={"#remarks#":n,"#server#":t,"#port#":e,"#uuid4#":I,"#password#":s,"#tls#":!o,"#hostName#":r,"#path#":c,"#fp#":atob(J(T)),"#tlstr#":o?"":"tls;"},u=new RegExp(Object.keys(l).join("|"),"g"),A=y(J(g)).replace(u,e=>l[e]);C.includes(n)||(d.push(A),C.push(n))}return[C,d]}function ee(e,t,r,n="/",i=0){let o=r.endsWith(atob("LndvcmtlcnMuZGV2")),a=o?x:H,{uuid:I,password:s,onSs:l}=t,c=n,g=["ICAtIHsidHlwZSI6InZsZXNzIiwibmFtZSI6IiNyZW1hcmtzIyIsInNlcnZlciI6IiNzZXJ2ZXIjIiwicG9ydCI6I3BvcnQjLCJ1dWlkIjoiI3V1aWQ0IyIsIm5ldHdvcmsiOiJ3cyIsInRscyI6I3RscyMsInVkcCI6ZmFsc2UsInNlcnZlcm5hbWUiOiIiLCJjbGllbnQtZmluZ2VycHJpbnQiOiIjZnAjIiwic2tpcC1jZXJ0LXZlcmlmeSI6dHJ1ZSwid3Mtb3B0cyI6eyJwYXRoIjoiI3BhdGgjIiwiaGVhZGVycyI6eyJIb3N0IjoiI2hvc3ROYW1lIyJ9fX0=","ICAtIHsidHlwZSI6InRyb2phbiIsIm5hbWUiOiIjcmVtYXJrcyMiLCJzZXJ2ZXIiOiIjc2VydmVyIyIsInBvcnQiOiNwb3J0IywicGFzc3dvcmQiOiIjcGFzc3dvcmQjIiwibmV0d29yayI6IndzIiwidWRwIjpmYWxzZSwic25pIjoiIiwiY2xpZW50LWZpbmdlcnByaW50IjoiI2ZwIyIsInNraXAtY2VydC12ZXJpZnkiOnRydWUsIndzLW9wdHMiOnsicGF0aCI6IiNwYXRoIyIsImhlYWRlcnMiOnsiSG9zdCI6IiNob3N0TmFtZSMifX19",...l?["ICAtIHsidHlwZSI6InNzIiwibmFtZSI6IiNyZW1hcmtzIyIsInNlcnZlciI6IiNzZXJ2ZXIjIiwicG9ydCI6I3BvcnQjLCJjaXBoZXIiOiJub25lIiwicGFzc3dvcmQiOiJub25lIiwicGx1Z2luIjoidjJyYXktcGx1Z2luIiwicGx1Z2luLW9wdHMiOnsibW9kZSI6IndlYnNvY2tldCIsInRscyI6I3RscyMsImhvc3QiOiIjaG9zdE5hbWUjIiwicGF0aCI6IiNwYXRoIyIsIm11eCI6ZmFsc2V9LCJ1ZHAiOmZhbHNlfQ"]:[]],C=[],d=[];for(let t of e){if(!t)continue;let e=0!==i?i:J(a),n=`cfwks-${t}:${e}`,l={"#remarks#":n,"#server#":t,"#port#":e,"#uuid4#":I,"#password#":s,"#tls#":!o,"#hostName#":r,"#path#":c,"#fp#":atob(J(T))},u=new RegExp(Object.keys(l).join("|"),"g"),A=y(J(g)).replace(u,e=>l[e]);C.includes(n)||(d.push(A),C.push(n))}return[C,d]}var D="61098bdc-b734-4874-9e87-d18b1ef1cfaf",oe="b379f280b9a4ce21e465cb31eea09a8fe3f4f8dd1850d9f630737538",pe="",fe="",me="",he=`${["2602","fc59","b0","64"].join(":")}::`,v=!1,ie=["0.0.0.0/0","::/0"],te=["https://www.bilibili.com","https://www.nicovideo.jp","https://tv.naver.com","https://www.hotstar.com","https://www.netflix.com","https://www.dailymotion.com","https://www.youtube.com","https://www.hulu.com","https://fmovies.llc","https://hdtodayz.to","https://radar.cloudflare.com"],be={github:{GITHUB_TOKEN:"",GITHUB_OWNER:"",GITHUB_REPO:"",GITHUB_BRANCH:"main",GITHUB_FILE_PATH:"README.md"},password:{CONFIG_PASSWORD:"",SUB_PASSWORD:""},urls:{DATA_SOURCE_URL:"https://raw.githubusercontent.com/juerson/3h1_tunnel/refs/heads/master/domain.txt",CLASH_TEMPLATE_URL:"https://raw.githubusercontent.com/juerson/3h1_tunnel/refs/heads/master/clashTemplate.yaml"}},re={"djJyYXk=":{upperLimit:2e3,default:300},"c2luZ2JveA==":{upperLimit:100,default:30},"Y2xhc2g=":{upperLimit:100,default:30},"":{upperLimit:500,default:300}},O={},ae={hostname:null,port:443},ce="",U=!1,B=!1,P=!1,lt={async fetch(e,t,r){try{D=t.UUID4||D;let r=t.USERPWD||D;oe=F(r),v=(()=>{let e=t.ENABLED_S5;return"boolean"==typeof e?e:"string"==typeof e?["1","true","yes","on"].includes(e.trim().toLowerCase()):v})();let n=(t.ALLOWED_RULES??"").trim().split(/[, \n\r\t]+/).map(e=>e.trim()).filter(Boolean);ie=n.length>0?n:["0.0.0.0/0","::/0"];let i=new URL(e.url),o=i.pathname,a=e.headers.get("Upgrade");if(a&&"websocket"===a)return O={},U=!1,B=!1,P=!1,({parsedSocks5Address:O,parsedLandingAddress:ae,nat64IPv6Prefix:ce,enableSocks:U,enableHttp:B,enableNat:P}=Me(o,t,pe,fe,me,he)),await ye(e);{let e={env:Ye(t,be),query:Ee(i,re),subParameter:{uuid:D,password:r,onSs:v}};return await we(o,e,re)}}catch(e){return new Response(e.toString())}}};async function we(e,t,r){let{target:n,hostName:i,pwdPassword:o,defaultPort:a,maxNode:I,page:s,nodePath:l,cidr:c}=t.query,{CONFIG_PASSWORD:g,SUB_PASSWORD:C}=t.env.password,{DATA_SOURCE_URL:d,CLASH_TEMPLATE_URL:u}=t.env.urls,A=t.env.github;switch(e){case"/":let e=te[Math.floor(Math.random()*te.length)];return Response.redirect(e,301);case"/config":let m="404 Not Found!",p=404;return o==g&&(m=K(t?.subParameter,i,l),p=200),new Response(m,{status:p,headers:{"Content-Type":"text/html; charset=UTF-8"}});case"/sub":if(o==C){let e=M(c,I);if(0===e.length){let t="";if(function(e){return Object.values(e).every(e=>""!==e)}(A))try{let e=await Y(A?.GITHUB_TOKEN,A?.GITHUB_OWNER,A?.GITHUB_REPO,A?.GITHUB_FILE_PATH,A?.GITHUB_BRANCH);t=(new TextDecoder).decode(e.body)}catch(e){console.log(`获取GitHub的数据失败：${e.message}`)}if(t.trim()||(t=await L(d)),!t.trim())return new Response("Null Data",{status:200,headers:{"Content-Type":"text/plain;charset=utf-8"}});e=t.trim().split(/\r\n|\n|\r/).map(e=>e.trim()).filter(e=>e.length>0)}let o=E(e,I,s,r[n]?.upperLimit??r[""]?.upperLimit,r[n]?.default??r[""]?.default);if(o?.hasError)return new Response(o.message,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}});let g="Not Found!";if("djJyYXk="===n)g=_(o?.chunkedIPs,t?.subParameter,i,l,a);else if("c2luZ2JveA=="===n){let[e,r]=q(o?.chunkedIPs,t?.subParameter,i,l,a);r.length>0&&(g=y("ew0KICAib3V0Ym91bmRzIjogWw0KI291dGJkcyMNCiAgXQ0KfQ").replace("#outbds#",r.join(",\n")))}else if("Y2xhc2g="===n){if(i.endsWith(y("d29ya2Vycy5kZXY")))return g=y("6K2m5ZGK77ya5L2/55So5Z+f5ZCNI2hvc3ROYW1lI+eUn+aIkOeahGNsYXNo6K6i6ZiF5peg5rOV5L2/55So77yB57uI5q2i5pON5L2c44CC").replace("#hostName#",i),new Response(g,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}});let[e,r]=ee(o?.chunkedIPs,t?.subParameter,i,l,a),n=await L(u);r.length>0&&r.length>0&&(g=function(e,t){return e.replace(/(\s*[-*]\s*)\$\{(\w+)\}/g,(e,r,n)=>"\n"+t[n])}(n,{proxies:r.join("\n"),proxy_name:e.map(e=>`      - ${e}`).join("\n")}))}return new Response(g,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}})}default:return new Response("Not Found!",{status:404,headers:{"Content-Type":"text/plain; charset=utf-8"}})}}async function ye(e){let[t,r]=Object.values(new WebSocketPair);r.accept();let n="",i="",o=(e,t)=>{console.log(`[${n}:${i}] ${e}`,t||"")},a=new AbortController,{resetIdleTimer:I,controller:s}=Ze({webSocket:r,signal:a.signal,idleTimeoutMs:2e4,maxLifetimeMs:18e4,onAbort:e=>{o?.("🐳 disconnecting reason:",e),k(r)}}),l=e.headers.get("sec-websocket-protocol")||"",c=Je(r,l,o),g=null,C={value:null},d=Ne({webSocket:r,remoteSocketWrapper:C,timeoutMs:5e3,log:o});try{c.pipeTo(new WritableStream({async write(t,a){if(I(),C.value){let e=C.value.writable.getWriter();return await e.write(t),void e.releaseLock()}let s=Ve(t,e,ie),l={...v?{0:[Ge,[t]]}:{},1:[je,[t,D]],2:[We,[t,oe]]}[s];if(!l)return o(`Unsupported protocol mapCode: ${s}`);let[c,u]=l,A=c(...u);if(!A||A?.hasError)return a.error(`Header parse error: ${A?.message}`);if(d(),!A?.isUDP||53==A?.portRemote){if(A?.isUDP){let{write:e}=await Le(r,A?.responseHeader,o);return g=e,void g(A?.rawClientData)}n=A?.addressRemote,i=`${A?.portRemote}--${Math.random()} ${A?.isUDP?"udp ":"tcp "}`,$e(C,A,r,o)}},close(){o("webSocketReadableStream is close")},abort(e){o("webSocketReadableStream is abort",JSON.stringify(e))}}),{signal:s.signal}).catch(e=>{o("webSocketReadableStream pipeTo error",e)})}catch(e){"AbortError"===e.name?o("Stream aborted by AbortController, usually due to a timeout or explicit cancellation:",e):o("Unexpected pipeTo error:",e)}return new Response(null,{status:101,webSocket:t})}function Ne({webSocket:e,remoteSocketWrapper:t,timeoutMs:r=5e3,log:n}){let i=setTimeout(()=>{if(!t.value){n("🤝 Handshake timeout: no protocol header received, closing WebSocket");try{e.readyState===WebSocket.OPEN&&e.close(1008,"Handshake timeout")}catch(e){n("Failed to close WebSocket after timeout",e)}}},r);return()=>clearTimeout(i)}function Ze({webSocket:e,signal:t,onAbort:r,idleTimeoutMs:n=3e4,maxLifetimeMs:i=18e4}){let o=null,a=null,I=new AbortController,s=!1,l=()=>{clearTimeout(o),clearTimeout(a),t&&C&&t.removeEventListener("abort",C)},c=t=>{s||(s=!0,console.warn("idle"===t?`⏳ Idle for over ${n/1e3}s, disconnecting.`:`🛑 Max lifetime of ${i/1e3}s reached, disconnecting.`),k(e),I.abort(),r?.(t),l())},g=()=>{clearTimeout(o),!s&&(o=setTimeout(()=>c("idle"),n))},C=()=>{c("external")};return g(),a=setTimeout(()=>c("lifetime"),i),t?.addEventListener("abort",C),{controller:I,resetIdleTimer:g,cleanup:l}}function Je(e,t,r){let n=!1;return new ReadableStream({start(i){e.addEventListener("message",e=>{n||i.enqueue(e.data)}),e.addEventListener("close",()=>{n||i.close(),k(e)}),e.addEventListener("error",e=>{r("WebSocket error"),i.error(`ReadableStream error: ${e.message}`)});let{earlyData:o,error:a}=Qe(t);a?i.error(`Base64 decode error: ${a.message}`):o&&i.enqueue(o)},cancel(t){n||(n=!0,r(`ReadableStream canceled: ${t}`),k(e))}})}function je(e,t){let r=new Uint8Array(e);if(r.length<24)return{hasError:!0,message:"Too short"};if(n=r.slice(1,17),[...n].map((e,t)=>`${[4,6,8,10].includes(t)?"-":""}${e.toString(16).padStart(2,"0")}`).join("")!==t)return{hasError:!0,message:"Unauthorized UUID"};var n;let i=18+r[17],o=!1,a=r[i];if(2===a)o=!0;else if(1!==a)return{hasError:!0,message:`command ${a} is not support`};let I=r[i+1]<<8|r[i+2],s=i+3,l=r[s++],c="";if(1===l)c=`${r[s++]}.${r[s++]}.${r[s++]}.${r[s++]}`;else if(2===l){let e=r[s++],t=[];for(let n=0;n<e;++n)t.push(r[s+n]);c=String.fromCharCode(...t),s+=e}else{if(3!==l)return{hasError:!0,message:`Invalid address type ${l}`};{let e=[];for(let t=0;t<8;++t){let t=r[s++],n=r[s++];e.push((t<<8|n).toString(16))}c=e.join(":")}}return{hasError:!1,addressRemote:c,portRemote:I,rawClientData:new Uint8Array(e,s),addressType:(e=>({1:1,2:3,3:4}[e]??null))(l),responseHeader:new Uint8Array([r[0],0]),isUDP:o}}function We(e,t){let r=new Uint8Array(e);if(r.length<64)return{hasError:!0,message:"Header too short"};if(String.fromCharCode(...r.slice(0,56))!==t)return{hasError:!0,message:"Unauthorized password"};if(13!==r[56]||10!==r[57])return{hasError:!0,message:"Missing CRLF after password hash"};let n=!1,i=58,o=r[i++];if(3==o)n=!0;else if(1!==o&&3!==o)return{hasError:!0,message:`Unknown CMD: ${o}`};let a=r[i++],I="";if(1===a){if(r.length<i+4+2)return{hasError:!0,message:"Header too short for IPv4"};I=`${r[i++]}.${r[i++]}.${r[i++]}.${r[i++]}`}else if(3===a){let e=r[i++];if(r.length<i+e+2)return{hasError:!0,message:"Header too short for domain"};I=String.fromCharCode(...r.slice(i,i+e)),i+=e}else{if(4!==a)return{hasError:!0,message:`Unknown addrType: ${a}`};{if(r.length<i+16+2)return{hasError:!0,message:"Header too short for IPv6"};let e=[];for(let t=0;t<8;++t){let t=r[i++]<<8|r[i++];e.push(t.toString(16))}I=e.join(":")}}return{hasError:!1,addressRemote:I,portRemote:r[i++]<<8|r[i++],rawClientData:new Uint8Array(e,i+2),addressType:a,responseHeader:null,isUDP:n}}function Ge(e){let t=new DataView(e),r=t.getUint8(0),n="",i=1,o=new TextDecoder;if(1===r)n=Array.from(new Uint8Array(e.slice(1,5))).join("."),i=5;else if(3===r){let r=t.getUint8(1);n=o.decode(e.slice(2,2+r)),i=2+r}else{if(4!==r)return{hasError:!0,message:`Invalid addressType: ${r}`};{let e=[];for(let r=0;r<8;r++)e.push(t.getUint16(1+2*r).toString(16));n=e.join(":"),i=17}}return{hasError:!1,addressRemote:n,portRemote:new DataView(e.slice(i,i+2)).getUint16(0),rawClientData:e.slice(i+2),addressType:r,responseHeader:null,isUDP:!1}}async function $e(e,t,r,n){let{addressType:i,addressRemote:o,portRemote:a,rawClientData:I,responseHeader:s}=t;async function l(t,r,{socks:o=!1,http:a=!1}={}){let s=o?await Se(i,t,r,n):a?await Be(t,r,n):z({hostname:t,port:r});n(`connected to ${t}:${r}`),e.value=s;let l=s.writable.getWriter();return await l.write(I),l.releaseLock(),s}let c=await l(o,a);ne(c,r,s,async function(){let e=U?{socks:!0}:B?{http:!0}:{};if(U||B)c=await l(o,a,e);else{let{address:e,port:t}=await Te(o,a);c=await l(e,t)}c.closed.catch(e=>n("retry tcpSocket closed error",e)).finally(()=>k(r)),ne(c,r,s,null,n)},n)}async function Te(e,t,r=ae){return!P&&r?.hostname?{address:r.hostname,port:r.port||t}:{address:await ke(e)||e,port:t}}async function ke(e,t=ce){if("string"!=typeof e||!e.trim())return"";try{let r=await fetch(`https://dns.google.com/resolve?name=${e}&type=A`,{headers:{Accept:"application/dns-json"}});if(!r.ok)return"";let n=(await r.json()).Answer?.find(e=>1===e.type)?.data;if(!n)return"";let i=n.split(".");if(4!==i.length)return"";let o=i.map(e=>{let t=Number(e);return!Number.isInteger(t)||t<0||t>255?null:t.toString(16).padStart(2,"0")});return o.includes(null)?"":`[${t}${o[0]}${o[1]}:${o[2]}${o[3]}]`}catch{return""}}async function Se(e,t,r,n){let{username:i,password:o,hostname:a,port:I}=O,s=z({hostname:a,port:I}),l=new Uint8Array([5,2,0,2]),c=s.writable.getWriter();await c.write(l),n("sent socks greeting");let g,C=s.readable.getReader(),d=new TextEncoder,u=(await C.read()).value;if(5!==u[0])return void n(`socks server version error: ${u[0]} expected: 5`);if(255===u[1])return void n("no acceptable methods");if(2===u[1]){if(n("socks server needs auth"),!i||!o)return void n("please provide username/password");let e=new Uint8Array([1,i.length,...d.encode(i),o.length,...d.encode(o)]);if(await c.write(e),u=(await C.read()).value,1!==u[0]||0!==u[1])return void n("fail to auth socks server")}switch(e){case 1:g=new Uint8Array([1,...t.split(".").map(Number)]);break;case 3:g=new Uint8Array([3,t.length,...d.encode(t)]);break;case 4:g=new Uint8Array([4,...t.split(":").flatMap(e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)])]);break;default:return void n(`invild  addressType is ${e}`)}let A=new Uint8Array([5,1,0,...g,r>>8,255&r]);if(await c.write(A),n("sent socks request"),u=(await C.read()).value,0===u[1])return n("socks connection opened"),c.releaseLock(),C.releaseLock(),s;n("fail to open socks connection")}var He=new TextEncoder,De=new TextDecoder;function Re(e,t,r,n){let i=[`CONNECT ${e}:${t} HTTP/1.1`,`Host: ${e}:${t}`,"User-Agent: Mozilla/5.0 (Windows NT10.0; Win64; x64) AppleWebKit/537.36","Proxy-Connection: keep-alive","Connection: keep-alive"];if(r&&n){let e=btoa(`${r}:${n}`);i.push(`Proxy-Authorization: Basic ${e}`)}return i.join("\r\n")+"\r\n\r\n"}async function xe(e,t){let r=e.writable.getWriter();await r.write(He.encode(t)),r.releaseLock()}async function ve(e){let t=e.readable.getReader(),r=new Uint8Array(0);try{for(;;){let{value:n,done:i}=await t.read();if(i)throw new Error("HTTP连接被中断");r=Oe(r,n);let o=Ue(r);if(-1!==o){let t=De.decode(r.slice(0,o));if(/^HTTP\/1\.[01] 200/.test(t)){let t=r.slice(o+4);if(t.length){let r=e.readable.getWriter();r.write(t),r.close()}return!0}throw new Error(`HTTP代理响应异常: ${t.split("\r\n")[0]}`)}}}finally{t.releaseLock()}}function Oe(e,t){let r=e.length+t.length;if(0===e.length)return t;let n=new Uint8Array(r);return n.set(e),n.set(t,e.length),n}function Ue(e){for(let t=0;t<e.length-3;t++)if(13===e[t]&&10===e[t+1]&&13===e[t+2]&&10===e[t+3])return t;return-1}async function Be(e,t,r){let{hostname:n,port:i,username:o,password:a}=O;r(`准备使用HTTP代理 ${n}:${i} 连接 ${e}:${t}`);let I=await z({hostname:n,port:i}),s=Re(e,t,o,a);if(await xe(I,s),!await ve(I))throw new Error("HTTP代理连接失败");return r(`HTTP连接 ${e}:${t} 成功！`),I}async function ne(e,t,r=null,n,i){let o=!1,a=!0,I=r instanceof Uint8Array?r:null,s=new WritableStream({write(e,r){if(t.readyState!==WebSocket.OPEN)return r.error("WebSocket not open");try{let r;a&&I?(r=new Uint8Array(I.length+e.length),r.set(I,0),r.set(e,I.length),a=!1,I=null):r=e,t.send(r),o=!0}catch(e){r.error("WritableStream error",e)}},abort(e){console.error("WritableStream aborted:",e)}});try{await e.readable.pipeTo(s)}catch(e){console.error("pipeTo error in remoteSocketToWS:",e),k(t)}!o&&"function"==typeof n&&n()}function Qe(e){if(!e)return{earlyData:null,error:null};try{let t=e.replace(/-/g,"+").replace(/_/g,"/"),r=atob(t),n=r.length,i=new Uint8Array(n);for(let e=0;e<n;e++)i[e]=r.charCodeAt(e);return{earlyData:i.buffer,error:null}}catch(e){return{earlyData:null,error:e}}}function k(e,t=1e3,r="Normal Closure"){try{(e.readyState===WebSocket.OPEN||e.readyState===WebSocket.CONNECTING)&&e.close(t,r)}catch(e){console.error("Failed close WebSocket",e)}}async function Le(e,t,r){let n=!1,i=new TransformStream({start(e){},transform(e,t){for(let r=0;r<e.byteLength;){let n=e.slice(r,r+2),i=new DataView(n).getUint16(0),o=new Uint8Array(e.slice(r+2,r+2+i));r=r+2+i,t.enqueue(o)}},flush(e){}});i.readable.pipeTo(new WritableStream({async write(i){let o=await(await fetch("https://1.1.1.1/dns-query",{method:"POST",headers:{"content-type":"application/dns-message"},body:i})).arrayBuffer(),a=o.byteLength,I=new Uint8Array([a>>8&255,255&a]);e.readyState===WebSocket.OPEN&&(r(`doh success and dns message length is ${a}`),n?e.send(await new Blob([I,o]).arrayBuffer()):(e.send(await new Blob([t,I,o]).arrayBuffer()),n=!0))}})).catch(e=>r("dns udp has error"+e));let o=i.writable.getWriter();return{write(e){o.write(e)}}}function Ve(e,t=null,r=["0.0.0.0/0","::/0"]){let n=new Uint8Array(e);if(n.byteLength>=17){let e=(240&n[7])>>4;if(128==(192&n[9])&&(4===e||7===e))return 1}if(n.byteLength>=62){let[e,t,r,i]=[n[56],n[57],n[58],n[59]],o=[1,3,4];if(13===e&&10===t&&[1,3,127].includes(r)&&o.includes(i))return 2}if(n.byteLength>10&&[1,3,4].includes(n[0])&&Array.isArray(r)){if(r.some(e=>"0.0.0.0/0"===e||"::/0"===e))return 0;if(t){let e=t.headers.get("CF-Connecting-IP");if(e&&r.some(t=>Xe(e,t)))return 0}}return 3}function Xe(e,t){return!!["0.0.0.0/0","::/0"].includes(t)||(t.includes("/")?Pe(e,t):e===t)}function Pe(e,t){let[r,n="32"]=t.split("/"),i=se(e),o=se(r),a=parseInt(n,10);if(e.includes(".")&&r.includes(".")){let e=~((1<<32-a)-1)>>>0;return Number(i&BigInt(e))===Number(o&BigInt(e))}if(e.includes(".")||r.includes("."))return!1;{let e=(1n<<128n)-(1n<<128n-BigInt(a));return(i&e)===(o&e)}}function se(e){if(e.includes(".")){let[t,r,n,i]=ze(e);return BigInt(t<<24|r<<16|n<<8|i)}return Fe(e).reduce((e,t)=>(e<<16n)+BigInt(t),0n)}function ze(e){return e.split(".").map(e=>parseInt(e,10))}function Fe(e){let t=e.split("::"),r=t[0].split(":").filter(Boolean),n=t[1]?t[1].split(":").filter(Boolean):[],i=8-(r.length+n.length);return[...r,...Array(i).fill("0"),...n].map(e=>parseInt(e||"0",16))}function Ye(e,t,r=["CONFIG_PASSWORD","SUB_PASSWORD"]){let n={};for(let[i,o]of Object.entries(t)){n[i]={};for(let[t,a]of Object.entries(o)){let o=e[t]??a;r.includes(t)&&(o=encodeURIComponent(String(o))),n[i][t]=o}}return n}function Ee(e,t,r=["pwdPassword"]){let n=e.searchParams,i=R(n.get("target"))||"",o=t[i]?.default??t[""]?.default,a={target:i,hostName:n.get("host")||e.hostname,pwdPassword:n.get("pwd")||"",defaultPort:parseInt(n.get("port")||"0",10),maxNode:parseInt(n.get("max")||o.toString(),10),page:parseInt(n.get("page")||"1",10),nodePath:n.get("path")||"/",cidr:n.get("cidr")||""};for(let e of r)e in a&&(a[e]=encodeURIComponent(a[e]));return a}function Me(e,t,r,n,i,o){let a=t.SOCKS5||r,I=t.HTTP||n,s=t.LANDING_ADDRESS||i,l=t.NAT64||o,c=e.includes("/socks="),g=e.match(/\/(https?)=([^/]+)/i),C=e.includes("/pyip="),d=e.includes("/nat="),u=!1,A=!1,m=!1,p={hostname:null,port:443},h={};if(c){h=S(e.split("/socks=")[1]),u=!0}else if(g){h=S(g[2]),A=!0}else if(C){let t=e.split("/pyip=")[1].split(",");p=X(t[Math.floor(Math.random()*t.length)].trim())}else if(d)l=e.split("/nat=")[1],m=!0;else if(a)h=S(a),u=!0;else if(I)h=S(I),A=!0;else if(s){let e=s.split(",");p=X(e[Math.floor(Math.random()*e.length)].trim())}return{parsedSocks5Address:h,parsedLandingAddress:p,nat64IPv6Prefix:l.split("/")[0],enableSocks:u,enableHttp:A,enableNat:m}}export{lt as default};