import{connect as L}from"cloudflare:sockets";function R(e){if("string"!=typeof e)throw new TypeError("sha224Encrypt: input must be a string");let t=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function r(e,t){return e>>>t|e<<32-t}let n=(new TextEncoder).encode(e),a=8*n.length,o=n.length+9+63>>6<<6,s=new Uint8Array(o);s.set(n),s[n.length]=128,new DataView(s.buffer).setUint32(s.length-4,a,!1);let i=new Uint32Array(64),l=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428].slice();for(let e=0;e<s.length;e+=64){let n=new DataView(s.buffer,e,64);for(let e=0;e<16;e++)i[e]=n.getUint32(4*e);for(let e=16;e<64;e++){let t=r(i[e-15],7)^r(i[e-15],18)^i[e-15]>>>3,n=r(i[e-2],17)^r(i[e-2],19)^i[e-2]>>>10;i[e]=i[e-16]+t+i[e-7]+n>>>0}let[a,o,c,d,u,f,p,w]=l;for(let e=0;e<64;e++){let n=w+(r(u,6)^r(u,11)^r(u,25))+(u&f^~u&p)+t[e]+i[e]>>>0,s=(r(a,2)^r(a,13)^r(a,22))+(a&o^a&c^o&c)>>>0;[w,p,f,u,d,c,o,a]=[p,f,u,d+n>>>0,c,o,a,n+s>>>0]}l[0]=l[0]+a>>>0,l[1]=l[1]+o>>>0,l[2]=l[2]+c>>>0,l[3]=l[3]+d>>>0,l[4]=l[4]+u>>>0,l[5]=l[5]+f>>>0,l[6]=l[6]+p>>>0,l[7]=l[7]+w>>>0}return l.slice(0,7).map(e=>e.toString(16).padStart(8,"0")).join("")}function D(e){let t,r,n=e=>(e=+e)>=1&&e<=65535?e:443,a=443;if("["===e[0]){if(-1===(r=e.indexOf("]")))return{hostname:null,port:null};t=e.slice(0,r+1),":"===e[r+1]&&(a=n(e.slice(r+2)))}else-1!==(r=e.lastIndexOf(":"))&&e.indexOf(":")===r?(t=e.slice(0,r),a=n(e.slice(r+1))):t=e;return{hostname:t,port:a}}function E(e){let t,r,n,a,[o,s]=e.split("@").reverse();if(s){let e=s.split(":");if(2!==e.length)throw new Error("Invalid SOCKS address format");[t,r]=e}let i=o.split(":");if(a=Number(i.pop()),isNaN(a))throw new Error("Invalid SOCKS address format");n=i.join(":");if(n.includes(":")&&!/^\[.*\]$/.test(n))throw new Error("Invalid SOCKS address format");return{username:t,password:r,hostname:n,port:a}}var k="61098bdc-b734-4874-9e87-d18b1ef1cfaf",B="b379f280b9a4ce21e465cb31eea09a8fe3f4f8dd1850d9f630737538",z="",K="",q="",G=`${["2602","fc59","b0","64"].join(":")}::`,v=!1,M=["0.0.0.0/0","::/0"],H=["https://www.bilibili.com","https://www.nicovideo.jp","https://tv.naver.com","https://www.hotstar.com","https://www.netflix.com","https://www.dailymotion.com","https://www.youtube.com","https://www.hulu.com","https://fmovies.llc","https://hdtodayz.to","https://radar.cloudflare.com"],I={},O={hostname:null,port:443},j="",U=!1,P=!1,C=!1,Ie={async fetch(e,t,r){try{k=t.UUID4||k,B=R(t.USERPWD||k),v=(()=>{let e=t.ENABLED_S5;return"boolean"==typeof e?e:"string"==typeof e?["1","true","yes","on"].includes(e.trim().toLowerCase()):v})();let r=(t.ALLOWED_RULES??"").trim().split(/[, \n\r\t]+/).map(e=>e.trim()).filter(Boolean);M=r.length>0?r:["0.0.0.0/0","::/0"];let n=new URL(e.url).pathname,a=e.headers.get("Upgrade");if(a&&"websocket"===a)return I={},U=!1,P=!1,C=!1,({parsedSocks5Address:I,parsedLandingAddress:O,nat64IPv6Prefix:j,enableSocks:U,enableHttp:P,enableNat:C}=Te(n,t,z,K,q,G)),await J(e);if("/"===n){let e=H[Math.floor(Math.random()*H.length)];return Response.redirect(e,301)}return new Response("404 Not Found!",{status:404})}catch(e){return new Response(e.toString())}}};async function J(e){let[t,r]=Object.values(new WebSocketPair);r.accept();let n="",a="",o=(e,t)=>{console.log(`[${n}:${a}] ${e}`,t||"")},s=new AbortController,{resetIdleTimer:i,controller:l}=Y({webSocket:r,signal:s.signal,idleTimeoutMs:2e4,maxLifetimeMs:18e4,onAbort:e=>{o?.("🐳 disconnecting reason:",e),$(r)}}),c=e.headers.get("sec-websocket-protocol")||"",d=X(r,c,o),u=null,f={value:null},p=Q({webSocket:r,remoteSocketWrapper:f,timeoutMs:5e3,log:o});try{d.pipeTo(new WritableStream({async write(t,s){if(i(),f.value){let e=f.value.writable.getWriter();return await e.write(t),void e.releaseLock()}let l=we(t,e,M),c={...v?{0:[te,[t]]}:{},1:[Z,[t,k]],2:[ee,[t,B]]}[l];if(!c)return o(`Unsupported protocol mapCode: ${l}`);let[d,w]=c,h=d(...w);if(!h||h?.hasError)return s.error(`Header parse error: ${h?.message}`);if(p(),!h?.isUDP||53==h?.portRemote){if(h?.isUDP){let{write:e}=await me(r,h?.responseHeader,o);return u=e,void u(h?.rawClientData)}n=h?.addressRemote,a=`${h?.portRemote}--${Math.random()} ${h?.isUDP?"udp ":"tcp "}`,re(f,h,r,o)}},close(){o("webSocketReadableStream is close")},abort(e){o("webSocketReadableStream is abort",JSON.stringify(e))}}),{signal:l.signal}).catch(e=>{o("webSocketReadableStream pipeTo error",e)})}catch(e){"AbortError"===e.name?o("Stream aborted by AbortController, usually due to a timeout or explicit cancellation:",e):o("Unexpected pipeTo error:",e)}return new Response(null,{status:101,webSocket:t})}function Q({webSocket:e,remoteSocketWrapper:t,timeoutMs:r=5e3,log:n}){let a=setTimeout(()=>{if(!t.value){n("🤝 Handshake timeout: no protocol header received, closing WebSocket");try{e.readyState===WebSocket.OPEN&&e.close(1008,"Handshake timeout")}catch(e){n("Failed to close WebSocket after timeout",e)}}},r);return()=>clearTimeout(a)}function Y({webSocket:e,signal:t,onAbort:r,idleTimeoutMs:n=3e4,maxLifetimeMs:a=18e4}){let o=null,s=null,i=new AbortController,l=!1,c=()=>{clearTimeout(o),clearTimeout(s),t&&f&&t.removeEventListener("abort",f)},d=t=>{l||(l=!0,console.warn("idle"===t?`⏳ Idle for over ${n/1e3}s, disconnecting.`:`🛑 Max lifetime of ${a/1e3}s reached, disconnecting.`),$(e),i.abort(),r?.(t),c())},u=()=>{clearTimeout(o),!l&&(o=setTimeout(()=>d("idle"),n))},f=()=>{d("external")};return u(),s=setTimeout(()=>d("lifetime"),a),t?.addEventListener("abort",f),{controller:i,resetIdleTimer:u,cleanup:c}}function X(e,t,r){let n=!1;return new ReadableStream({start(a){e.addEventListener("message",e=>{n||a.enqueue(e.data)}),e.addEventListener("close",()=>{n||a.close(),$(e)}),e.addEventListener("error",e=>{r("WebSocket error"),a.error(`ReadableStream error: ${e.message}`)});let{earlyData:o,error:s}=he(t);s?a.error(`Base64 decode error: ${s.message}`):o&&a.enqueue(o)},cancel(t){n||(n=!0,r(`ReadableStream canceled: ${t}`),$(e))}})}function Z(e,t){let r=new Uint8Array(e);if(r.length<24)return{hasError:!0,message:"Too short"};if(n=r.slice(1,17),[...n].map((e,t)=>`${[4,6,8,10].includes(t)?"-":""}${e.toString(16).padStart(2,"0")}`).join("")!==t)return{hasError:!0,message:"Unauthorized UUID"};var n;let a=18+r[17],o=!1,s=r[a];if(2===s)o=!0;else if(1!==s)return{hasError:!0,message:`command ${s} is not support`};let i=r[a+1]<<8|r[a+2],l=a+3,c=r[l++],d="";if(1===c)d=`${r[l++]}.${r[l++]}.${r[l++]}.${r[l++]}`;else if(2===c){let e=r[l++],t=[];for(let n=0;n<e;++n)t.push(r[l+n]);d=String.fromCharCode(...t),l+=e}else{if(3!==c)return{hasError:!0,message:`Invalid address type ${c}`};{let e=[];for(let t=0;t<8;++t){let t=r[l++],n=r[l++];e.push((t<<8|n).toString(16))}d=e.join(":")}}return{hasError:!1,addressRemote:d,portRemote:i,rawClientData:new Uint8Array(e,l),addressType:(e=>({1:1,2:3,3:4}[e]??null))(c),responseHeader:new Uint8Array([r[0],0]),isUDP:o}}function ee(e,t){let r=new Uint8Array(e);if(r.length<64)return{hasError:!0,message:"Header too short"};if(String.fromCharCode(...r.slice(0,56))!==t)return{hasError:!0,message:"Unauthorized password"};if(13!==r[56]||10!==r[57])return{hasError:!0,message:"Missing CRLF after password hash"};let n=!1,a=58,o=r[a++];if(3==o)n=!0;else if(1!==o&&3!==o)return{hasError:!0,message:`Unknown CMD: ${o}`};let s=r[a++],i="";if(1===s){if(r.length<a+4+2)return{hasError:!0,message:"Header too short for IPv4"};i=`${r[a++]}.${r[a++]}.${r[a++]}.${r[a++]}`}else if(3===s){let e=r[a++];if(r.length<a+e+2)return{hasError:!0,message:"Header too short for domain"};i=String.fromCharCode(...r.slice(a,a+e)),a+=e}else{if(4!==s)return{hasError:!0,message:`Unknown addrType: ${s}`};{if(r.length<a+16+2)return{hasError:!0,message:"Header too short for IPv6"};let e=[];for(let t=0;t<8;++t){let t=r[a++]<<8|r[a++];e.push(t.toString(16))}i=e.join(":")}}return{hasError:!1,addressRemote:i,portRemote:r[a++]<<8|r[a++],rawClientData:new Uint8Array(e,a+2),addressType:s,responseHeader:null,isUDP:n}}function te(e){let t=new DataView(e),r=t.getUint8(0),n="",a=1,o=new TextDecoder;if(1===r)n=Array.from(new Uint8Array(e.slice(1,5))).join("."),a=5;else if(3===r){let r=t.getUint8(1);n=o.decode(e.slice(2,2+r)),a=2+r}else{if(4!==r)return{hasError:!0,message:`Invalid addressType: ${r}`};{let e=[];for(let r=0;r<8;r++)e.push(t.getUint16(1+2*r).toString(16));n=e.join(":"),a=17}}return{hasError:!1,addressRemote:n,portRemote:new DataView(e.slice(a,a+2)).getUint16(0),rawClientData:e.slice(a+2),addressType:r,responseHeader:null,isUDP:!1}}async function re(e,t,r,n){let{addressType:a,addressRemote:o,portRemote:s,rawClientData:i,responseHeader:l}=t;async function c(t,r,{socks:o=!1,http:s=!1}={}){let l=o?await ae(a,t,r,n):s?await pe(t,r,n):L({hostname:t,port:r});n(`connected to ${t}:${r}`),e.value=l;let c=l.writable.getWriter();return await c.write(i),c.releaseLock(),l}let d=await c(o,s);N(d,r,l,async function(){let e=U?{socks:!0}:P?{http:!0}:{};if(U||P)d=await c(o,s,e);else{let{address:e,port:t}=await ne(o,s);d=await c(e,t)}d.closed.catch(e=>n("retry tcpSocket closed error",e)).finally(()=>$(r)),N(d,r,l,null,n)},n)}async function ne(e,t,r=O){return!C&&r?.hostname?{address:r.hostname,port:r.port||t}:{address:await se(e)||e,port:t}}async function se(e,t=j){if("string"!=typeof e||!e.trim())return"";try{let r=await fetch(`https://dns.google.com/resolve?name=${e}&type=A`,{headers:{Accept:"application/dns-json"}});if(!r.ok)return"";let n=(await r.json()).Answer?.find(e=>1===e.type)?.data;if(!n)return"";let a=n.split(".");if(4!==a.length)return"";let o=a.map(e=>{let t=Number(e);return!Number.isInteger(t)||t<0||t>255?null:t.toString(16).padStart(2,"0")});return o.includes(null)?"":`[${t}${o[0]}${o[1]}:${o[2]}${o[3]}]`}catch{return""}}async function ae(e,t,r,n){let{username:a,password:o,hostname:s,port:i}=I,l=L({hostname:s,port:i}),c=new Uint8Array([5,2,0,2]),d=l.writable.getWriter();await d.write(c),n("sent socks greeting");let u,f=l.readable.getReader(),p=new TextEncoder,w=(await f.read()).value;if(5!==w[0])return void n(`socks server version error: ${w[0]} expected: 5`);if(255===w[1])return void n("no acceptable methods");if(2===w[1]){if(n("socks server needs auth"),!a||!o)return void n("please provide username/password");let e=new Uint8Array([1,a.length,...p.encode(a),o.length,...p.encode(o)]);if(await d.write(e),w=(await f.read()).value,1!==w[0]||0!==w[1])return void n("fail to auth socks server")}switch(e){case 1:u=new Uint8Array([1,...t.split(".").map(Number)]);break;case 3:u=new Uint8Array([3,t.length,...p.encode(t)]);break;case 4:u=new Uint8Array([4,...t.split(":").flatMap(e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)])]);break;default:return void n(`invild  addressType is ${e}`)}let h=new Uint8Array([5,1,0,...u,r>>8,255&r]);if(await d.write(h),n("sent socks request"),w=(await f.read()).value,0===w[1])return n("socks connection opened"),d.releaseLock(),f.releaseLock(),l;n("fail to open socks connection")}var oe=new TextEncoder,ie=new TextDecoder;function le(e,t,r,n){let a=[`CONNECT ${e}:${t} HTTP/1.1`,`Host: ${e}:${t}`,"User-Agent: Mozilla/5.0 (Windows NT10.0; Win64; x64) AppleWebKit/537.36","Proxy-Connection: keep-alive","Connection: keep-alive"];if(r&&n){let e=btoa(`${r}:${n}`);a.push(`Proxy-Authorization: Basic ${e}`)}return a.join("\r\n")+"\r\n\r\n"}async function ce(e,t){let r=e.writable.getWriter();await r.write(oe.encode(t)),r.releaseLock()}async function de(e){let t=e.readable.getReader(),r=new Uint8Array(0);try{for(;;){let{value:n,done:a}=await t.read();if(a)throw new Error("HTTP连接被中断");r=ue(r,n);let o=fe(r);if(-1!==o){let t=ie.decode(r.slice(0,o));if(/^HTTP\/1\.[01] 200/.test(t)){let t=r.slice(o+4);if(t.length){let r=e.readable.getWriter();r.write(t),r.close()}return!0}throw new Error(`HTTP代理响应异常: ${t.split("\r\n")[0]}`)}}}finally{t.releaseLock()}}function ue(e,t){let r=e.length+t.length;if(0===e.length)return t;let n=new Uint8Array(r);return n.set(e),n.set(t,e.length),n}function fe(e){for(let t=0;t<e.length-3;t++)if(13===e[t]&&10===e[t+1]&&13===e[t+2]&&10===e[t+3])return t;return-1}async function pe(e,t,r){let{hostname:n,port:a,username:o,password:s}=I;r(`准备使用HTTP代理 ${n}:${a} 连接 ${e}:${t}`);let i=await L({hostname:n,port:a}),l=le(e,t,o,s);if(await ce(i,l),!await de(i))throw new Error("HTTP代理连接失败");return r(`HTTP连接 ${e}:${t} 成功！`),i}async function N(e,t,r=null,n,a){let o=!1,s=!0,i=r instanceof Uint8Array?r:null,l=new WritableStream({write(e,r){if(t.readyState!==WebSocket.OPEN)return r.error("WebSocket not open");try{let r;s&&i?(r=new Uint8Array(i.length+e.length),r.set(i,0),r.set(e,i.length),s=!1,i=null):r=e,t.send(r),o=!0}catch(e){r.error("WritableStream error",e)}},abort(e){console.error("WritableStream aborted:",e)}});try{await e.readable.pipeTo(l)}catch(e){console.error("pipeTo error in remoteSocketToWS:",e),$(t)}!o&&"function"==typeof n&&n()}function he(e){if(!e)return{earlyData:null,error:null};try{let t=e.replace(/-/g,"+").replace(/_/g,"/"),r=atob(t),n=r.length,a=new Uint8Array(n);for(let e=0;e<n;e++)a[e]=r.charCodeAt(e);return{earlyData:a.buffer,error:null}}catch(e){return{earlyData:null,error:e}}}function $(e,t=1e3,r="Normal Closure"){try{(e.readyState===WebSocket.OPEN||e.readyState===WebSocket.CONNECTING)&&e.close(t,r)}catch(e){console.error("Failed close WebSocket",e)}}async function me(e,t,r){let n=!1,a=new TransformStream({start(e){},transform(e,t){for(let r=0;r<e.byteLength;){let n=e.slice(r,r+2),a=new DataView(n).getUint16(0),o=new Uint8Array(e.slice(r+2,r+2+a));r=r+2+a,t.enqueue(o)}},flush(e){}});a.readable.pipeTo(new WritableStream({async write(a){let o=await(await fetch("https://1.1.1.1/dns-query",{method:"POST",headers:{"content-type":"application/dns-message"},body:a})).arrayBuffer(),s=o.byteLength,i=new Uint8Array([s>>8&255,255&s]);e.readyState===WebSocket.OPEN&&(r(`doh success and dns message length is ${s}`),n?e.send(await new Blob([i,o]).arrayBuffer()):(e.send(await new Blob([t,i,o]).arrayBuffer()),n=!0))}})).catch(e=>r("dns udp has error"+e));let o=a.writable.getWriter();return{write(e){o.write(e)}}}function we(e,t=null,r=["0.0.0.0/0","::/0"]){let n=new Uint8Array(e);if(n.byteLength>=17){let e=(240&n[7])>>4;if(128==(192&n[9])&&(4===e||7===e))return 1}if(n.byteLength>=62){let[e,t,r,a]=[n[56],n[57],n[58],n[59]],o=[1,3,4];if(13===e&&10===t&&[1,3,127].includes(r)&&o.includes(a))return 2}if(n.byteLength>10&&[1,3,4].includes(n[0])&&Array.isArray(r)){if(r.some(e=>"0.0.0.0/0"===e||"::/0"===e))return 0;if(t){let e=t.headers.get("CF-Connecting-IP");if(e&&r.some(t=>ge(e,t)))return 0}}return 3}function ge(e,t){return!!["0.0.0.0/0","::/0"].includes(t)||(t.includes("/")?ye(e,t):e===t)}function ye(e,t){let[r,n="32"]=t.split("/"),a=W(e),o=W(r),s=parseInt(n,10);if(e.includes(".")&&r.includes(".")){let e=~((1<<32-s)-1)>>>0;return Number(a&BigInt(e))===Number(o&BigInt(e))}if(e.includes(".")||r.includes("."))return!1;{let e=(1n<<128n)-(1n<<128n-BigInt(s));return(a&e)===(o&e)}}function W(e){if(e.includes(".")){let[t,r,n,a]=be(e);return BigInt(t<<24|r<<16|n<<8|a)}return Se(e).reduce((e,t)=>(e<<16n)+BigInt(t),0n)}function be(e){return e.split(".").map(e=>parseInt(e,10))}function Se(e){let t=e.split("::"),r=t[0].split(":").filter(Boolean),n=t[1]?t[1].split(":").filter(Boolean):[],a=8-(r.length+n.length);return[...r,...Array(a).fill("0"),...n].map(e=>parseInt(e||"0",16))}function Te(e,t,r,n,a,o){let s=t.SOCKS5||r,i=t.HTTP||n,l=t.LANDING_ADDRESS||a,c=t.NAT64||o,d=e.includes("/socks="),u=e.match(/\/(https?)=([^/]+)/i),f=e.includes("/pyip="),p=e.includes("/nat="),w=!1,h=!1,m=!1,g={hostname:null,port:443},y={};if(d){y=E(e.split("/socks=")[1]),w=!0}else if(u){y=E(u[2]),h=!0}else if(f){let t=e.split("/pyip=")[1].split(",");g=D(t[Math.floor(Math.random()*t.length)].trim())}else if(p)c=e.split("/nat=")[1],m=!0;else if(s)y=E(s),w=!0;else if(i)y=E(i),h=!0;else if(l){let e=l.split(",");g=D(e[Math.floor(Math.random()*e.length)].trim())}return{parsedSocks5Address:y,parsedLandingAddress:g,nat64IPv6Prefix:c.split("/")[0],enableSocks:w,enableHttp:h,enableNat:m}}export{Ie as default};